
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard - Cyber Complaint Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-indigo-700">Admin Dashboard</h1>
      <div class="flex items-center gap-4">
        <div id="notifyArea"></div>
        <button id="logoutBtn" class="bg-gray-200 px-3 py-1 rounded">Logout</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <section class="md:col-span-2 bg-white rounded p-4 shadow">
        <h2 class="text-lg font-semibold mb-3">All Complaints</h2>
        <div id="casesList" class="space-y-4"></div>
      </section>

      <aside class="bg-white rounded p-4 shadow">
        <h2 class="text-lg font-semibold mb-3">Filters & Actions</h2>
        <div class="space-y-3">
          <div>
            <label class="text-sm font-semibold">Filter by Status</label>
            <div id="filterButtons" class="mt-2 flex flex-wrap gap-2">
              <!-- Filter buttons will be dynamically inserted here -->
            </div>
          </div>
          <div>
            <label class="text-sm">Assign case to (username)</label>
            <input id="assignUser" class="mt-1 block w-full border p-2 rounded" placeholder="attender_bob" />
            <div id="assignError" class="text-xs text-red-600 mt-1 h-4"></div> <!-- Error message appears here -->
            <button id="assignBtn" class="mt-2 bg-indigo-600 text-white px-3 py-1 rounded">Assign Selected</button>
          </div>
        </div>
      </aside>
    </main>

    <section class="mt-6 bg-white rounded p-4 shadow">
      <h3 class="text-lg font-semibold mb-3">Case Details / Download</h3>
      <div id="caseDetail" class="text-sm text-gray-700">Select a case to view details</div>
    </section>
  </div>

  <script>
    const current = JSON.parse(localStorage.getItem('currentUser') || 'null');
    if (!current || current.role !== 'admin') window.location.href = 'login.html';

    const casesListEl = document.getElementById('casesList');
    const caseDetailEl = document.getElementById('caseDetail');
    const notifyArea = document.getElementById('notifyArea');
    let selectedCaseId = null;

    let allCases = []; // This will hold the data from the database

    async function fetchCases() {
        try {
            const response = await fetch('http://localhost:5001/complaints');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            // The data from DB is a bit different, let's adapt it
            allCases = data.map(c => {
                const transactions = JSON.parse(c.transactions);
                const totalAmount = transactions.reduce((sum, t) => sum + parseFloat(t.amount.replace('â‚¹', '')), 0);
                const firstTransaction = transactions[0] || {};

                return {
                    id: c.id,
                    complainant: c.name,
                    transactionId: firstTransaction.transaction_id || 'N/A',
                    handler: c.handler || '', // Assuming handler and status might be added later
                    status: c.status || 'Pending',
                    timeReceived: c.created_at,
                    evidenceContent: 'Evidence not available in this view', // Placeholder
                    idProofContent: 'ID Proof not available in this view', // Placeholder
                    transactionCount: transactions.length,
                    amount: totalAmount,
                    timestamp: firstTransaction.date ? `${firstTransaction.date} ${firstTransaction.time}` : 'N/A',
                    bankName: firstTransaction.bank_name || 'N/A',
                    accountNo: firstTransaction.account_no || 'N/A',
                    // Add new fields from the database response
                    district: c.district,
                    dob: c.dob,
                    father_name: c.father_name,
                    mobile_no: c.mobile_no,
                    pin_code: c.pin_code,
                    phone_number: c.phone_number // This is the whatsapp number
                };
            });
            // Get the current filter from the active button and re-render
            const activeFilter = document.querySelector('#filterButtons .bg-indigo-600').dataset.filter;
            renderCases(activeFilter);
        } catch (error) {
            console.error("Could not fetch complaints:", error);
            casesListEl.innerHTML = `<div class="text-red-500">Error loading complaints. Is the API server running on port 5001?</div>`;
        }
    }

    function formatTime(t) {
        const d = new Date(t);
        return d.toLocaleString();
    }

    function copyToClipboard(text, event) {
        navigator.clipboard.writeText(text).then(() => {
            const button = event.target.closest('button');
            if (!button) return;

            const originalContent = button.innerHTML;
            button.innerHTML = 'Copied!';
            button.disabled = true;

            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 30000);
        });
    }

    function downloadBlob(filename, content) {
        const blob = new Blob([content], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }
    // --- End of Shared Functions ---
    
    const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
    const copyButton = (text) => `<button onclick="copyToClipboard('${String(text).replace(/'/g, "\\'")}', event)" class="ml-2 text-blue-600 hover:text-blue-800" title="Copy">${copyIcon}</button>`;

    function renderCases(filter='all') {
      // Clear previous selections
      const previouslySelected = document.querySelector('.case-selected');
      if (previouslySelected) {
          previouslySelected.classList.remove('case-selected', 'ring-2', 'ring-indigo-500');
      }

      const filtered = filter === 'all' ? allCases : allCases.filter(c=>c.status===filter);
      casesListEl.innerHTML = '';
      filtered.forEach(c => {
        const div = document.createElement('div');
        div.className = 'p-3 border rounded flex flex-col md:flex-row justify-between items-start bg-gray-50';
        div.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-sm flex-grow">
                <div class="space-y-1">
                    <h4 class="text-md font-semibold text-gray-800 border-b pb-1">Personal Information</h4>
                    <div><strong>Name:</strong> ${c.complainant} ${copyButton(c.complainant)}</div>
                    <div><strong>Father's Name:</strong> ${c.father_name} ${copyButton(c.father_name)}</div>
                    <div><strong>Date of Birth:</strong> ${c.dob} ${copyButton(c.dob)}</div>
                    <div><strong>Mobile No:</strong> ${c.mobile_no} ${copyButton(c.mobile_no)}</div>
                    <div><strong>WhatsApp No:</strong> ${c.phone_number} ${copyButton(c.phone_number)}</div>
                    <div><strong>District:</strong> ${c.district} ${copyButton(c.district)}</div>
                    <div><strong>PIN Code:</strong> ${c.pin_code} ${copyButton(c.pin_code)}</div>
                    <div><strong>Handler:</strong> <span class="font-medium">${c.handler || 'â€” unassigned â€”'}</span> ${copyButton(c.handler || '')}</div>
                    <div class="text-xs text-gray-600 mt-2">Portal Entry: ${formatTime(c.timeReceived)} ${copyButton(formatTime(c.timeReceived))}</div>
                </div>
                <div class="space-y-1 mt-4 md:mt-0">
                    <h4 class="text-md font-semibold text-gray-800 border-b pb-1">Transaction Summary</h4>
                     ${c.transactions.map((txn, i) => `
                        <div class="p-2 border rounded mb-2 bg-gray-100">
                            <p class="font-semibold">Transaction #${i + 1}</p>
                            <div><strong>Date & Time:</strong> ${txn.date} ${txn.time} ${copyButton(`${txn.date} ${txn.time}`)}</div>
                            <div><strong>Amount:</strong> ${txn.amount} ${copyButton(txn.amount)}</div>
                            <div><strong>Bank:</strong> ${txn.bank_name} ${copyButton(txn.bank_name)}</div>
                            <div><strong>Account No:</strong> ${txn.account_no} ${copyButton(txn.account_no)}</div>
                            <div><strong>Transaction ID:</strong> ${txn.transaction_id} ${copyButton(txn.transaction_id)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'flex flex-col items-end gap-2';

        const selectButtonHTML = `<div><button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="selectCase(${c.id}, '${c.handler || ''}')">Select Case</button></div>`;

        // Create a dropdown of attenders for direct assignment
        const attenderOptions = validAttenders.map(attender => `<option value="${attender}" ${c.handler === attender ? 'selected' : ''}>${attender}</option>`).join('');
        const assignDropdownHTML = `
            <div class="mt-2 flex items-center gap-2">
                <select id="attender-select-${c.id}" class="border p-1 rounded text-sm w-32">${attenderOptions}</select>
                <button class="bg-indigo-600 text-white px-3 py-1 rounded text-sm" onclick="assignCaseFromList(${c.id})">Assign</button>
            </div>`;

        actionsContainer.innerHTML = `
            ${selectButtonHTML}
            <div><button class="bg-green-100 text-green-800 px-2 py-1 rounded" onclick="downloadCaseDetails(${c.id})">Download Details</button></div>
            ${assignDropdownHTML}
        `;

        div.appendChild(actionsContainer);
        casesListEl.appendChild(div);

        // Re-apply selection highlight if this case is the selected one
        if (c.id === selectedCaseId) {
            div.classList.add('case-selected', 'ring-2', 'ring-indigo-500');
        }
      });
    }

    function createFilterButtons() {
        const filterContainer = document.getElementById('filterButtons');
        const filters = ['all', 'Pending', 'In Progress', 'Completed'];
        filterContainer.innerHTML = ''; // Clear existing buttons

        filters.forEach(filter => {
            const button = document.createElement('button');
            button.textContent = filter.charAt(0).toUpperCase() + filter.slice(1); // Capitalize
            button.dataset.filter = filter;
            button.className = 'filter-btn px-3 py-1 rounded text-sm';
            
            // Style the default 'all' button as active
            if (filter === 'all') {
                button.classList.add('bg-indigo-600', 'text-white');
            } else {
                button.classList.add('bg-gray-200', 'text-gray-800');
            }

            filterContainer.appendChild(button);
        });
    }

    function copyLocal(val, event) { 
        navigator.clipboard.writeText(val).then(() => {
            const button = event.target.closest('button');
            if (!button) return;
            const originalContent = button.innerHTML;
            button.innerHTML = 'Copied!';
            setTimeout(() => {
                button.innerHTML = originalContent;
            }, 30000);
        });
    }

    function selectCase(id, currentHandler = '') {
      // Remove highlight from previously selected case
      const previouslySelected = document.querySelector('.case-selected');
      if (previouslySelected) {
          previouslySelected.classList.remove('case-selected', 'ring-2', 'ring-indigo-500');
      }
      // Add highlight to the new selected case
      const caseCard = document.querySelector(`#casesList [onclick="selectCase(${id}, '${currentHandler || ''}')"]`).closest('.p-3');
      if(caseCard) caseCard.classList.add('case-selected', 'ring-2', 'ring-indigo-500');

      selectedCaseId = id;
      const c = allCases.find(x=>x.id===id);
      caseDetailEl.innerHTML = `
        <div class="flex justify-between items-center mb-2 pb-2 border-b">
            <h4 class="text-lg font-semibold">Selected Case: ${id}</h4>
        </div>
        <div class="space-y-2">
          <div><strong>Complainant:</strong> ${c.complainant}</div>
          <div><strong>Txn ID:</strong> <input readonly value="${c.transactionId}" class="border p-1 rounded w-64 inline" /> <button onclick="copyLocal('${c.transactionId}', event)" class="ml-2 text-blue-600 hover:text-blue-800" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block align-text-bottom" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button></div>
          <div><strong>Handler:</strong> ${c.handler || 'â€” unassigned â€”'}</div>
          <div><strong>Status:</strong> ${c.status}</div>
          <div><strong>DB Entry Time:</strong> ${formatTime(c.timeReceived)}</div>
          <div class="mt-2 pt-2 border-t"><strong>Case Occurred Time:</strong> ${formatTime(c.timestamp)}</div>
          <div><strong>Amount:</strong> ${c.amount}</div>
          <div><strong>Transaction Count:</strong> ${c.transactionCount}</div>
          <div><strong>Bank Name:</strong> ${c.bankName}</div>
          <div><strong>Account No:</strong> ${c.accountNo}</div>
          <div class="mt-2">
            <button class="bg-green-600 text-white px-3 py-1 rounded" onclick="downloadCaseDetails(${c.id})">Download Details as TXT</button>
          </div>
        </div>
      `;
      // Also populate the 'assignUser' input with the current handler to make re-assigning easier
      const assignUserInput = document.getElementById('assignUser');
      assignUserInput.value = currentHandler;
      validateAssignee(); // Re-validate the user in the input
    }

    function downloadCaseDetails(id) {
      const c = allCases.find(x=>x.id===id);
      
      // Construct the detailed content string
      const fileContent = `
Case Details for: ${c.complainant}
--------------------------------------------------
DB Entry Time: ${formatTime(c.timeReceived)}
Case Occurred Time: ${formatTime(c.timestamp)}
Amount: ${c.amount}
Transaction Count: ${c.transactionCount}
Bank Name: ${c.bankName || 'N/A'}
Account No: ${c.accountNo || 'N/A'}
Handler: ${c.handler || 'â€” unassigned â€”'}
`;
      downloadBlob('case_details_' + id + '.txt', fileContent.trim());
    }

    document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('currentUser'); window.location.href='login.html'; });

    // --- User Validation Logic ---
    let validAttenders = [];
    const assignUserInput = document.getElementById('assignUser');
    const assignErrorEl = document.getElementById('assignError');

    async function fetchAttenders() {
        try {
            const response = await fetch('/users/attenders');
            validAttenders = await response.json();
        } catch (error) {
            console.error("Could not fetch attenders:", error);
            assignErrorEl.textContent = 'Could not load users.';
        }
    }

    function validateAssignee() {
        const username = assignUserInput.value.trim();
        if (username && !validAttenders.includes(username)) {
            assignErrorEl.textContent = 'Invalid user.';
        } else {
            assignErrorEl.textContent = '';
        }
    }

    assignUserInput.addEventListener('input', validateAssignee);

    // New function to assign a case directly from the list
    async function assignCaseFromList(caseId) {
        const attenderSelect = document.getElementById(`attender-select-${caseId}`);
        const username = attenderSelect.value;

        if (!username) return alert('Please select an attender from the dropdown.');
        if (!validAttenders.includes(username)) return alert('Cannot assign to an invalid user.');

        const c = allCases.find(x => x.id === caseId);
        const originalHandler = c.handler;
        const originalStatus = c.status;

        // Optimistic UI update
        c.handler = username;
        c.status = 'In Progress';
        // Get the current filter from the active button and re-render
        const activeFilter = document.querySelector('#filterButtons .bg-indigo-600').dataset.filter;
        renderCases(activeFilter);

        try {
            const response = await fetch(`/complaints/${caseId}/claim`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ handler: username, status: 'In Progress' }),
            });
            if (!response.ok) throw new Error('Server failed to assign case.');
        } catch (error) {
            alert('Error assigning case: ' + error.message + '. Reverting changes.');
            c.handler = originalHandler;
            c.status = originalStatus;
            renderCases(activeFilter);
        }
    }

    // Assign selected case
    document.getElementById('assignBtn').addEventListener('click', async () => {
      const username = assignUserInput.value.trim();
      if (!selectedCaseId) return alert('Select a case first');
      if (!username) return alert('Enter username to assign');
      if (!validAttenders.includes(username)) return alert('Cannot assign to an invalid user.');

      const c = allCases.find(x=>x.id===selectedCaseId);
      const originalHandler = c.handler;
      const originalStatus = c.status;

      // Optimistic UI update
      c.handler = username;
      c.status = 'In Progress';
      // Get the current filter from the active button and re-render
      const activeFilter = document.querySelector('#filterButtons .bg-indigo-600').dataset.filter;
      renderCases(activeFilter);

      try {
        const response = await fetch(`/complaints/${selectedCaseId}/claim`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ handler: username, status: 'In Progress' }),
        });
        if (!response.ok) throw new Error('Server failed to assign case.');
        alert(`Case ${selectedCaseId} assigned to ${username} and saved.`);
      } catch (error) {
        console.error("Error assigning case:", error);
        alert('Error assigning case: ' + error.message + '. Reverting changes.');
        c.handler = originalHandler;
        c.status = originalStatus;
        renderCases(activeFilter);
      }
    });

    document.getElementById('filterButtons').addEventListener('click', (e) => {
        if (e.target.classList.contains('filter-btn')) {
            const filterValue = e.target.dataset.filter;
            
            // Update active button styling
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });
            e.target.classList.add('bg-indigo-600', 'text-white');
            e.target.classList.remove('bg-gray-200', 'text-gray-800');

            // Render cases with the selected filter
            renderCases(filterValue);
        }
    });

    // --- Stale Case Notification Logic ---
    let notifiedStaleCaseIds = new Set(); // Keep track of cases we've alerted for

    function checkStale() {
      const now = Date.now();
      const STALE_SECONDS = 1800; // Changed from 30 minutes

      // Find all cases that are currently stale
      const staleCases = allCases.filter(c => 
        c.status === 'Pending' && 
        (now - new Date(c.timeReceived)) / 1000 > STALE_SECONDS
      );

      // Find which of these are new and haven't been notified via pop-up yet
      const newStaleCases = staleCases.filter(c => !notifiedStaleCaseIds.has(c.id));

      if (newStaleCases.length > 0) {
        // Add the new ones to the notified set to prevent re-alerting
        newStaleCases.forEach(c => notifiedStaleCaseIds.add(c.id));

        // Show a one-time pop-up alert for the new stale cases
        const caseIds = newStaleCases.map(c => c.id).join(', ');
        alert(`ðŸš¨ PENDING CASE ALERT ðŸš¨\n\n${newStaleCases.length} case(s) have been pending for over ${STALE_SECONDS} seconds.\n\nCase IDs: ${caseIds}`);
      }

      // Update the persistent banner notification with the total count of stale cases
      if (staleCases.length > 0) {
        notifyArea.innerHTML = `<div class="bg-yellow-100 border border-yellow-300 text-yellow-800 px-3 py-1 rounded">âš ï¸ ${staleCases.length} case(s) pending > ${STALE_SECONDS} seconds</div>`;
      } else {
        notifyArea.innerHTML = '';
      }
    }

    // auto-check every 30 seconds
    setInterval(checkStale, 30000);

    // initial render
    createFilterButtons(); // Create the filter buttons on page load
    fetchAttenders(); // Fetch the list of valid attenders
    fetchCases().then(() => checkStale()); // Fetch cases, then run the first check
  </script>
<script src="api_fetch.js"></script>
</body>
</html>
